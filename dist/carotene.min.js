/*! Carotene v0.2.1 */
!function(a){a.extend({bullet:function(b,c){"use strict";var d=0,e=1,f=2,g=3,h=b.replace("ws:","http:").replace("wss:","https:"),i=null;b===h&&(void 0===c?c={disableWebSocket:!0}:c.disableWebSocket=!0);var j=function(b){if(this.readyState!==d&&this.readyState!==e)return!1;var c=this,f={"X-Socket-Transport":"xhrPolling"};return i&&(f["Connection-id"]=i),a.ajax({async:!1,cache:!1,type:"POST",url:h,data:b,dataType:"text",contentType:"application/x-www-form-urlencoded; charset=utf-8",headers:f,success:function(a){a&&0!==a.length&&c.onmessage({data:a})}}),!0},k={websocket:function(){var a=null;return void 0!==c&&c.disableWebSocket?!1:(window.WebSocket&&(a=window.WebSocket),window.MozWebSocket&&-1===navigator.userAgent.indexOf("Firefox/6.0")&&(a=window.MozWebSocket),a?{heart:!0,transport:a}:null)},eventsource:function(){if(void 0!==c&&c.disableEventSource)return!1;if(!window.EventSource)return!1;var a=new window.EventSource(h);a.onopen=function(){b.readyState=e,b.onopen()},a.onmessage=function(a){b.onmessage(a)},a.onerror=function(){a.close(),a=void 0,b.onerror()};var b={readyState:d,send:j,close:function(){b.readyState=g,a.close(),a=void 0,b.onclose()}};return{heart:!1,transport:function(){return b}}},xhrPolling:function(){if(void 0!==c&&c.disableXHRPolling)return!1;var b,f=null,k={readyState:d,send:j,close:function(){this.readyState=g,f&&(f.abort(),f=null),clearTimeout(b),k.onclose()},onopen:function(){},onmessage:function(){},onerror:function(){},onclose:function(){}};function l(){var b={"X-Socket-Transport":"xhrPolling"};i&&(b["Connection-id"]=i),f=a.ajax({type:"GET",cache:!1,url:h,dataType:"text",data:{},headers:b,success:function(a,b,c){f=null,"connection-id"===a&&(i=c.getResponseHeader("connection-id"),n.onopen()),k.readyState===d&&(k.readyState=e,k.onopen(k)),a&&0!==a.length&&"connection-id"!==a&&k.onmessage({data:a}),k.readyState===e&&m()},error:function(a){a=null,k.onerror()}})}function m(){b=setTimeout(function(){l()},100)}return m(),{heart:!1,transport:function(){return k}}}},l=0;function m(){var a=0;for(var c in k){if(l===a){var d=k[c]();if(d){var e=new d.transport(b);return e.heart=d.heart,e}l++}a++}return!1}var n=new function(){var a=!0,c=g,h,i=80,j=80,k=1e4,o;function p(){return a=!1,c=d,(o=m())?(o.onopen=function(){i=j,o.heart&&(h=setInterval(function(){n.onheartbeat()},2e4)),c!==e&&(c=e,n.onopen())},o.onclose=function(){a||c===g||(o=null,clearInterval(h),c===f?(c=g,o=!1,n.onclose()):(c===d&&l++,i*=2,i>k&&(i=k),a=!0,setTimeout(function(){p()},i)))},o.onerror=o.onclose,void(o.onmessage=function(a){n.onmessage(a)})):(i=j,l=0,n&&n.ondisconnect(),setTimeout(function(){p()},k),!1)}p(),this.onopen=function(){},this.onmessage=function(){},this.ondisconnect=function(){},this.onclose=function(){},this.onheartbeat=function(){},this.setURL=function(a){b=a},this.send=function(a){if(o){var b=o.send(a);return void 0===b||b}return!1},this.close=function(){c=f,o&&o.close()}};return n}})}(jQuery);function caroteneConstructor(){"use strict";var a=null,b=null,c=null,d=null,e="CLOSED",f={},g=null,h=null,i=function(a){var c=JSON.stringify({subscribe:a});b.send(c)},j=function(a){b.send(a)},k=function(a){g=a},l=function(a){h=a},m=function(){c&&b.send(JSON.stringify({authenticate:c,token:d}))},n=function(){for(var a in f)i(a)},o=function(a,c){b.send(JSON.stringify({publish:c,channel:a}))},p=function(){b=$.bullet(a,{disableWebSocket:!1,disableEventSource:!0}),b.onopen=function(a){q(a)},b.onclose=function(a){r(a)},b.onmessage=function(a){t(a)},b.onerror=function(a){s(a)}},q=function(a){e="OPEN",m(),n()},r=function(a){e="CLOSED"},s=function(a){},t=function(a){var b=JSON.parse(a.data);if("[object Array]"===Object.prototype.toString.call(b))for(var c=0;c<b.length;++c)u(b[c]);else u(b)},u=function(a){if("type"in a)switch(a.type){case"message":v(a);break;case"presence":w(a);break;case"info":x(a);break;default:return}},v=function(a){var b={};"from_server"in a&&"true"===a.fromServer&&(b.fromServer=!0),"user_id"in a&&(b.userId=a.user_id),"user_data"in a&&(b.userData=a.user_data),"message"in a&&(b.message=JSON.parse(a.message)),a.channel in f&&f[a.channel].onMessage(b)},w=function(a){this.onPresence&&this.onPresence({channel:a.channel,subscribers:a.subscribers})},x=function(a){this.onInfo&&this.onInfo(a)};return{init:function(b){a=b.caroteneUrl,c=b.userId,p()},subscribe:function(a){var b=a.channel,c=a.onMessage;f[b]={onMessage:c},"OPEN"===e&&i(b)},publish:function(a){var b=a.channel,c=a.message;o(b,JSON.stringify(c))},authenticate:function(a){c=a.userId,d=a.token,"OPEN"===e&&m({userId:c,token:d})},presence:function(a){channel=a.channel;var b=JSON.stringify({presence:channel});j(b)},setOnPresence:function(a){k(a)},setOnInfo:function(a){l(a)}}}var Carotene=new caroteneConstructor;
//# sourceMappingURL=carotene.min.map